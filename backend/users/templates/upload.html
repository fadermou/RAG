{% extends "base.html" %}

{% block title %}RAG System{% endblock %}

{% block content %}
<h2>RAG System</h2>

<!-- Upload Section -->
<section id="upload-section">
  <h3>Upload Document</h3>
  <form id="upload-form">
    <input type="text" id="title" placeholder="Document Title" required>
    <input type="url" id="source" placeholder="Source URL (optional)">
    <input type="file" id="file">
    <button type="submit">Upload</button>
  </form>
  <p id="upload-message" style="color: lightgreen;"></p>
</section>

<hr>

<!-- Query Section -->
<section id="query-section">
  <h3>Ask a Question</h3>
  <form id="query-form">
    <input type="text" id="query" placeholder="Enter your question..." required>
    <button type="submit">Ask</button>
  </form>
  <div id="answer" style="margin-top: 10px; color: lightblue;"></div>
</section>

<script>
// Redirect if not authenticated
const token = localStorage.getItem("accessToken");
if (!token) window.location.href = "/user/login/";

// Upload Document
document.getElementById("upload-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("title", document.getElementById("title").value);
  formData.append("source", document.getElementById("source").value);
  const file = document.getElementById("file").files[0];
  if (file) formData.append("file", file);

  try {
    const res = await fetch("/documents/upload", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });
    const data = await res.json();
    if (res.ok) {
      document.getElementById("upload-message").textContent = "Upload successful!";
    } else {
      document.getElementById("upload-message").textContent = data.detail || "Upload failed";
    }
  } catch (err) {
    document.getElementById("upload-message").textContent = "Network error";
  }
});

// Query
document.getElementById("query-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const query = document.getElementById("query").value;

  try {
    const res = await fetch("/user/query/", { // replace with your query API
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ query })
    });
    const data = await res.json();
    document.getElementById("answer").textContent = data.answer || "No answer returned";
  } catch (err) {
    document.getElementById("answer").textContent = "Network error";
  }
});
</script>
{% endblock %}
